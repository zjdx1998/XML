"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();!function(){window.$clamp=function(e,t){function a(e,t){return u.getComputedStyle||(u.getComputedStyle=function(e,t){return this.el=e,this.getPropertyValue=function(t){var a=/(\-([a-z]){1})/g;return"float"==t&&(t="styleFloat"),a.test(t)&&(t=t.replace(a,function(e,t,a){return a.toUpperCase()})),e.currentStyle&&e.currentStyle[t]?e.currentStyle[t]:null},this}),u.getComputedStyle(e,null).getPropertyValue(t)}function n(t){t=t||e.clientHeight;var a=r(e);return Math.max(Math.floor(t/a),0)}function i(t){return r(e)*t}function r(e){var t=a(e,"line-height");return"normal"==t&&(t=1.2*parseInt(a(e,"font-size"))),parseInt(t)}function o(t){return t.lastChild.children&&0<t.lastChild.children.length?o(Array.prototype.slice.call(t.children).pop()):t.lastChild&&t.lastChild.nodeValue&&""!=t.lastChild.nodeValue&&t.lastChild.nodeValue!=p.truncationChar?t.lastChild:(t.lastChild.parentNode.removeChild(t.lastChild),o(e))}function l(t,a){if(a){var n=t.nodeValue.replace(p.truncationChar,"");if(w||(C=0<v.length?v.shift():"",w=n.split(C)),1<w.length?(y=w.pop(),c(t,w.join(C))):w=null,s&&(t.nodeValue=t.nodeValue.replace(p.truncationChar,""),e.innerHTML=t.nodeValue+" "+s.innerHTML+p.truncationChar),w){if(e.clientHeight<=a){if(!(0<=v.length&&""!=C))return e.innerHTML;c(t,w.join(C)+C+y),w=null}}else""==C&&(c(t,""),t=o(e),v=p.splitOnChars.slice(0),C=v[0],y=w=null);if(!p.animate)return l(t,a);setTimeout(function(){l(t,a)},!0===p.animate?10:p.animate)}}function c(e,t){e.nodeValue=t+p.truncationChar}t=t||{};var s,u=window,p={clamp:t.clamp||2,useNativeClamp:"undefined"==typeof t.useNativeClamp||t.useNativeClamp,splitOnChars:t.splitOnChars||[".","-","–","—"," "],animate:t.animate||!1,truncationChar:t.truncationChar||"…",truncationHTML:t.truncationHTML},m=e.style,d=e.innerHTML,h="undefined"!=typeof e.style.webkitLineClamp,f=p.clamp,_=f.indexOf&&(-1<f.indexOf("px")||-1<f.indexOf("em"));p.truncationHTML&&(s=document.createElement("span"),s.innerHTML=p.truncationHTML);var w,y,v=p.splitOnChars.slice(0),C=v[0];"auto"==f?f=n():_&&(f=n(parseInt(f)));var g;return h&&p.useNativeClamp?(m.overflow="hidden",m.textOverflow="ellipsis",m.webkitBoxOrient="vertical",m.display="-webkit-box",m.webkitLineClamp=f,_&&(m.height=p.clamp+"px")):(m=i(f),m<=e.clientHeight&&(g=l(o(e),m))),{original:d,clamped:g}}}();var Item=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){$clamp(this.abstract,{clamp:3,useNativeClamp:!1,truncationChar:"...",truncationHTML:""})}},{key:"render",value:function(){var e=this,t=this.props,a=t.target,n=(t.vote,t.source,t.topic);return React.createElement("div",{className:"topic-item"},React.createElement("div",{className:"item-meta"},React.createElement("a",{href:a.author.url,target:"_blank",className:"avator_a"},React.createElement("img",{className:"avator",src:a.author.avatar,alt:a.author.name})),React.createElement("a",{className:"author",href:a.author.url,target:"_blank"},a.author.name),React.createElement("time",{className:"time"},moment(a.create_time).fromNow().replace(/\s/g,""))),React.createElement("a",{href:a.url,target:"_blank",className:"abstract",ref:function(t){e.abstract=t}},a.abstract),React.createElement("div",{className:"action"},2===n.content_type?React.createElement("span",{className:"item"},a.useful_count,"/",a.useful_count+a.useless_count," 有用"):React.createElement("span",{className:"item"},a.likers_count," 喜欢"),React.createElement("span",{className:"item"},a.comments_count," 回应")))}}]),t}(React.Component),Topic=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props.topic,t=e.topic,a=e.items,n=[].concat(a).splice(0,window.topic_item_display_count),i=2===t.content_type?"new_review?topic_id="+t.id:"//www.douban.com/note/create?topic_id="+t.id;return React.createElement("div",{className:"topic-block"},React.createElement("div",{className:"meta"},React.createElement("a",{href:t.sharing_url,target:"_blank",className:"title"},t.name),React.createElement("span",{className:"count"},t.card_subtitle,React.createElement("span",null," · "),React.createElement("a",{href:i,rel:"nofollow",className:"write_review"},React.createElement("span",null,window.join_label_text)))),React.createElement("div",{className:"posts"},n.map(function(e,a){return React.createElement(Item,{target:e.article,vote:e.vote_status,source:e.source,topic:t})}),t.post_count>window.topic_item_display_count?React.createElement("span",null,"> ",React.createElement("a",{href:t.sharing_url,target:"_blank"},"更多",window.review_name,t.post_count,"篇")):null))}}]),t}(React.Component),Stream=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.state={stream:[],total:null,start:0,doing:!1,is_fold:!1},a}return _inherits(t,e),_createClass(t,[{key:"componentWillMount",value:function(){this.load(window.topic_display_count)}},{key:"load",value:function(e){var t=this;this.state.doing||(this.setState({doing:!0}),0!==e&&$.ajax({url:"https://m.douban.com/rexxar/api/v2/gallery/subject_feed?start="+this.state.start+"&count="+e+"&subject_id="+window.subject_id+"&ck="+get_cookie("ck"),xhrFields:{withCredentials:!0},success:function(e){t.setState({stream:t.state.stream.concat(e.items),total:e.total,start:t.state.start+e.items.length,doing:!1}),0===e.total&&""!==window.no_content_fun_call_name&&window[window.no_content_fun_call_name](),$("#topic-count").text(e.total)}}))}},{key:"fold",value:function(e){this.setState({is_fold:!e})}},{key:"render",value:function(){var e=this.state,t=e.total,a=e.stream,n=e.is_fold;return React.createElement("div",{className:"react-root"},a.slice(0,n?window.topic_display_count:a.length).map(function(e,t){return React.createElement(Topic,{key:t,topic:e})}),t&&t>=window.topic_display_count&&t!==a.length?React.createElement("div",{className:"topic-more",onClick:this.load.bind(this,t-this.state.start)},"( ",React.createElement("a",{href:"javascript:;;"},"展开全部话题")," )"):null,t&&t>window.topic_display_count&&t===a.length?React.createElement("div",{className:"topic-more",onClick:this.fold.bind(this,n)},"( ",React.createElement("a",{href:"javascript:;;"},n?"展开全部话题":"收起话题")," )"):null)}}]),t}(React.Component);ReactDOM.render(React.createElement(Stream,null),document.getElementById("topic-items"));try{var hideGuide=localStorage.getItem("topic_guide_hide");hideGuide?window.guideNode.style.display="none":(window.guideNode.style.display="block",window.guideNodeClose.addEventListener("click",function(e){localStorage.setItem("topic_guide_hide","1"),window.guideNode.style.display="none"}))}catch(e){}