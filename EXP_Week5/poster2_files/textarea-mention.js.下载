Array.prototype.indexOf=Array.prototype.indexOf||function(e){for(var t=-1,i=0,s=this.length;i<s;i++)if(this[i]===e)return i;return t},function(e){var t,i,s=140,o=0,n=0,r=10,l="",a=[],c="",h='<div id="{ID}" class="suggest-overlay"></div>',u=e(document.body),d=/ /g,g=/<\/?b>/g,f=e.browser.version<7?"&nbsp;":"x";ie_old=e.browser.msie&&e.browser.version<9,methods={getCarePos:function(i,s){var o=e("<em>&nbsp;</em>"),i=e(i),n=i.offset(),r={};return t||(t=e("<pre></pre>").css(this.initPreStyle(i)),t.appendTo("body")),ie_old&&(s=s.replace(d,f)),t.html(s).append(o),r=o.position(),{left:r.left+n.left+2,top:r.top+n.top+21}},initPreStyle:function(e){return{position:"absolute",left:-9999,width:e.width()+"px","font-family":e.css("font-family"),"font-size":e.css("font-size"),"word-wrap":"break-word",border:"1px"}},highlightName:function(t,i){return e.each(t,function(e,t){ie_old&&(t=t.replace(d,"&nbsp;")),l=t.split(":"),i=i.replace(new RegExp("@"+l[1],"g"),'<code data-id="'+l[0]+'">@'+l[1]+"</code>")}),i},updateHighlight:function(t,i,s){ie_old&&(s=s.replace(d,f)),e(t).html(this.highlightName(i,s))},moveSelectedItem:function(t){var s=i.find("li");o=i.find(".on").index(),n&&(o+=t,o>=n&&(o-=n),o<0&&(o===-2&&(o=-1),o+=n),s.removeClass("on"),e(s[o]).addClass("on"))},getCursorPosition:function(e){if(document.selection){e.focus();var t=document.selection,i=t.createRange(),s=i.duplicate();return s.moveToElementText(e),s.setEndPoint("EndToEnd",i),e.selectionStart=s.text.length-i.text.length,e.selectionEnd=e.selectionStart+i.text.length,e.selectionStart}return e.selectionStart},setCursorPosition:function(e,t){this.selectRangeText(e,t,t)},selectRangeText:function(e,t,i){if(document.selection){var s=e.createTextRange();s.moveEnd("character",-e.value.length),s.moveEnd("character",i),s.moveStart("character",t),s.select()}else e.setSelectionRange(t,i),e.focus()},deleteRangeText:function(t,i){var s=this.getCursorPosition(t),o=t.scrollTop,n=t.value;t.value=i>0?n.slice(0,s-i)+n.slice(s):n.slice(0,s)+n.slice(s-i),this.setCursorPosition(t,s-(i<0?0:i)),firefox=e.browser.mozilla&&setTimeout(function(){t.scrollTop!==o&&(t.scrollTop=o)},10)},insertAfterCursor:function(t,i,s){t.value;if(document.selection)t.focus(),document.selection.createRange().text=i+" ",this.updateHighlight(s,a,t.value);else{var o=t.selectionStart,n=t.value.length,r=t.scrollTop;t.value=t.value.slice(0,o)+i+t.value.slice(o,n)+" ",this.updateHighlight(s,a,t.value),this.setCursorPosition(t,o+i.length+1),firefox=e.browser.mozilla&&setTimeout(function(){t.scrollTop!==r&&(t.scrollTop=r)},0)}}},e.fn.textbox=function(t){var o={mode:"complete",itemCount:10,customData:null,highlighter:".highlighter",tips:"@某人,&nbsp;他能收到你的消息"},l=e.extend(o,t),d=this,f=!0,p=!1,m=function(t,o){var n=(t.value,i.find(".on")),r=n.attr("data-id")||n.attr("id")||"",h=e.trim(n.text().split("(")[0]),u=(r+":"+h).replace(g,"");a.indexOf(u)==-1&&a.push(u),methods.deleteRangeText(t,c.length),methods.insertAfterCursor(t,h,o),l.onMention&&l.onMention.call(d,r,h,a),"undefined"!=typeof App&&"complete"===l.mode&&App.Widgets.StatusBox.updateNum(s-e.trim(t.value).length),i.hide()},v=function(){i.html('<div class="bd">'+l.tips+"</div>")},b=function(t,s,o){var a=t.value,h=a.substring(0,o).lastIndexOf("@"),u=a.substring(h,o).indexOf(" "),d={};c=a.substring(h+1,o);var g=l.customData,f=l.mode,p=l.itemCount,b=l.listTmpl;if("complete"!==f?x(t):"@"===s&&(d=methods.getCarePos(t,a.substring(0,o-1)),y(t,d)),h===-1||u!==-1)return i&&i.hide();if(!(c.length>r)){if("complete"===f&&(d=methods.getCarePos(t,a.substring(0,h))),!c){var g=g&&g(),C=g&&g.users;return C&&C.length?(n=C.length,i.html(Mustache.to_html(b,g)),void i.children().click(function(){m(t,highlighter)})):v()}e.getJSON(l.dataUrl,{count:p,word:c},function(s){if(s&&s.users||(s={users:[]}),s.users.length<p&&g){var o={};e.each(s.users,function(e,t){o[t.uid]=1}),s.users=s.users.concat(g(c,p-s.users.length,o).users)}return s.users.length?(i.get(0).innerHTML=Mustache.to_html(b,s),i.find("li").hasClass("on")||i.find("li:first").attr("class","on"),n=i.find("li").size(),void("complete"===f?y(t,d):x(t))):i.hide()})}},y=function(t,s){e("#db-suggest-flist").remove(),i=e("#db-suggest-list"),i.length||(i=e(h.replace("{ID}","db-suggest-list")),i.appendTo("body"));var o=e(t);i.css({marginLeft:o.css("paddingLeft"),marginTop:o.css("paddingTop"),top:s.top+"px",left:s.left+"px"}).show(),i.children().click(function(){m(t,l.highlighter)})},x=function(t){e("#db-suggest-list").remove(),i=e("#db-suggest-flist"),i.length||(i=e(h.replace("{ID}","db-suggest-flist")),e(t).before(i[0]));var s=e(".comment-item").length;i.css({left:0,top:s?"auto":"71px",bottom:s?"43px":"auto",width:"272px"}).show(),i.children().click(function(){m(t,l.highlighter)})};this.bind("keyup input propertychange",function(t){if(this._closed)return e(l.highlighter).html("");if("propertychange"!=t.type||"value"===t.originalEvent.propertyName){var s="input"==t.type||"propertychange"==t.type;if(s?this._from_change=!0:this._from_change=!1,!s||this._from_change){var o=this,n=o.value,r=r||e(l.highlighter),c=methods.getCursorPosition(this),h=n.charAt(c-1);n||r.html(""),c<n.length+1&&a.length&&f&&(r.css("marginTop",-o.scrollTop),methods.updateHighlight(r,a,n)),38!==t.keyCode&&40!==t.keyCode&&13!==t.keyCode&&16!==t.keyCode&&9!==t.keyCode&&b(this,h,c),(9===t.keyCode||13===t.keyCode)&&i&&i.find(".on").size()&&i.is(":visible")&&m(this,l.highlighter)}}}),this.bind("keydown",function(t){if(f=!((t.ctrlKey||t.metaKey)&&65===t.keyCode||t.shiftKey&&(37===t.keyCode||39===t.keyCode)),i&&i.is(":visible")&&i.find("ul").length)switch(t.keyCode){case 32:i.hide();break;case 38:t.preventDefault(),methods.moveSelectedItem(-1);break;case 40:t.preventDefault(),methods.moveSelectedItem(1);break;case 8:var s=i.find("li");if(1==s.length){var o=this,n=o.value,r=methods.getCursorPosition(o),l=n.slice(0,r),a=l.slice(0,l.lastIndexOf("@")),c=e.trim(s.text().split("(")[0]),h=l.slice(l.lastIndexOf("@")+1);h==c&&(n=o.value=a+n.slice(r),methods.setCursorPosition(o,r-h.length))}break;case 9:case 13:t.preventDefault();break;default:p=!1}}),u.delegate(".suggest-overlay li","hover",function(){e(this).parent().children(".on").removeClass().end().end().toggleClass("on")}),u.click(function(e){i&&i.length&&i.hide()}),this.bind("mention",function(e,t,i,s){var o=(t+":"+i).replace(g,"");a.indexOf(o)==-1&&a.push(o),methods.insertAfterCursor(this,"@"+i,s)})}}(jQuery);
